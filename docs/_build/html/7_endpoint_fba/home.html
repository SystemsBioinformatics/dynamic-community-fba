<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>7. EndPointFBA &mdash; dynamic-community-fba  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8. Advanced Topics" href="../8_Advanced/home.html" />
    <link rel="prev" title="6. Dynamic Parallel FBA" href="../6_parallel_dfba/home.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            dynamic-community-fba
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1_installation/home.html">1. Installation and Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_getting_started/home.html">2. CBMPy Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_DynamicFBA/home.html">3. Dynamic FBA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_community_matrix/home.html">4. The community model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5_djoint/home.html">5. Dynamic Joint FBA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6_parallel_dfba/home.html">6. Dynamic Parallel FBA</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">7. EndPointFBA</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example">7.1 Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#examining-the-results">7.2 Examining the results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-constraints">7.3 Advanced constraints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#enforcing-balanced-growth">7.3.1 Enforcing balanced growth</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimal-time-search">7.3.2 Optimal time search</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restricting-reaction-bounds">7.3.3 Restricting reaction bounds</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../8_Advanced/home.html">8. Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../9_faq/home.html">9. FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10_API/DCFBA.html">10. API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">dynamic-community-fba</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">7. EndPointFBA</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/7_endpoint_fba/home.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="endpointfba">
<h1>7. EndPointFBA<a class="headerlink" href="#endpointfba" title="Permalink to this heading"></a></h1>
<p>The final method implemented in this package is called <cite>EndPointFBA</cite> (epFBA).
EndPointFBA is a dynamic simulation method for microbial
communities provided by this package.</p>
<p>In contrast to the previous methods, epFBA does not perform FBA, updates biomasses and metabolite concentrations per time step.
Rather, we duplicate the original GSMM for N time steps of size δt and connect each of these models chronologically,
such that metabolites and biomass can flow from time point to time point, but never backwards. This creates a multi-organism, multi-time-step compartmentalization of the original model.
After comprising such a time-step dependent GSMM, we perform FBA on the entire model.
Just like djFBA, we maximize the community biomass. For djFBA, this is calculated for every time step,
while here we maximize the exchange of community biomass in the final time point.</p>
<p>For a more extensive explanation of epFBA we refer you to the paper <a class="footnote-reference brackets" href="#ref-epfba" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> .</p>
<section id="example">
<h2>7.1 Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h2>
<p>We’ll use a lightweight toy model for this example to ensure the
computational load remains manageable.</p>
<p>The toy model is bundled with the package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cbmpy.CBModel</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Reaction</span>
<span class="kn">from</span> <span class="nn">dcFBA.ToyModels</span> <span class="kn">import</span> <span class="n">model_a</span><span class="p">,</span> <span class="n">model_b</span>

<span class="n">m_a</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">model_a</span><span class="o">.</span><span class="n">build_toy_model_fba_A</span><span class="p">()</span>

<span class="c1"># Setting some initial bounds on reactions</span>
<span class="n">m_a</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setUpperBound</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">m_a</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setUpperBound</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">m_a</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_6&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setUpperBound</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">m_a</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLowerBound</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">m_a</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLowerBound</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">m_a</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_6&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLowerBound</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Delete the original biomass model from model A as it is redefined in the endPoint model</span>
<span class="n">reaction</span><span class="p">:</span> <span class="n">Reaction</span> <span class="o">=</span> <span class="n">m_a</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_BM_A&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">deleteReagentWithSpeciesRef</span><span class="p">(</span>
    <span class="s2">&quot;BM_e_A&quot;</span>
<span class="p">)</span>

<span class="n">m_b</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">model_b</span><span class="o">.</span><span class="n">build_toy_model_fba_B</span><span class="p">()</span>

<span class="c1"># Setting some initial bounds on reactions</span>
<span class="n">m_b</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setUpperBound</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">m_b</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setUpperBound</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">m_b</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_5&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setUpperBound</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">m_b</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLowerBound</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">m_b</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLowerBound</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">m_b</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_5&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLowerBound</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Delete the original biomass model from model B</span>
<span class="n">reaction</span><span class="p">:</span> <span class="n">Reaction</span> <span class="o">=</span> <span class="n">m_b</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="s2">&quot;R_BM_B&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">deleteReagentWithSpeciesRef</span><span class="p">(</span>
    <span class="s2">&quot;BM_e_B&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Next, let’s create the initial <code class="docutils literal notranslate"><span class="pre">CommunityModel</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dcFBA.Models</span> <span class="kn">import</span> <span class="n">CommunityModel</span>

<span class="n">community_model</span> <span class="o">=</span> <span class="n">CommunityModel</span><span class="p">(</span>
    <span class="p">[</span><span class="n">m_a</span><span class="p">,</span> <span class="n">m_b</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;R_BM_A&quot;</span><span class="p">,</span> <span class="s2">&quot;R_BM_B&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;modelA&quot;</span><span class="p">,</span> <span class="s2">&quot;modelB&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To run a simulation with <code class="docutils literal notranslate"><span class="pre">EndPointFBA</span></code>, you’ll need to initialize the object by providing the following:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">CommunityModel</span></code></p></li>
<li><p>The desired number of time points</p></li>
<li><p>Initial concentrations for both biomass and metabolites</p></li>
<li><p>The time step size</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dcFBA.DynamicModels</span> <span class="kn">import</span> <span class="n">EndPointFBA</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">ep</span> <span class="o">=</span> <span class="n">EndPointFBA</span><span class="p">(</span>
    <span class="n">community_model</span><span class="p">,</span>
    <span class="n">n</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;modelA&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;modelB&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;S_e&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;A_e&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;B_e&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">solution</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">simulate</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
<span class="c1"># 12.778</span>
</pre></div>
</div>
<p>This provides the community biomass value after 25 intervals of 0.1 time units each.</p>
</section>
<section id="examining-the-results">
<h2>7.2 Examining the results<a class="headerlink" href="#examining-the-results" title="Permalink to this heading"></a></h2>
<p>Reactions in the <code class="docutils literal notranslate"><span class="pre">EndPointFBA</span></code> model have unique IDs formed by
appending their original IDs with the time ID (e.g., R_1_timeNN).
Also, metabolite flow between time points are represented with a
unique ID combining the metabolite’s ID and the start and end
interval IDs. These ID’s are stored in the <code class="docutils literal notranslate"><span class="pre">fluxes</span></code> object. To access the flux from a reaction it can be examined as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fluxes</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">get_fluxes</span><span class="p">()</span>

<span class="c1">#Obtain the aggregated flux value of reaction 1 of model A in the fifth time point</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fluxes</span><span class="p">[</span><span class="s2">&quot;R_1_model_A_time05&quot;</span><span class="p">])</span> <span class="c1">#1.2763</span>
</pre></div>
</div>
<p>The concentration of an external metabolite at a specific time point is retained within the linking reaction between this time-point and the previous.
This holds true for all external metabolites consumed and synthesized within the system, as they progress through each time step until reaching the final one.
To ascertain the quantity of metabolite X at the commencement of time-step 4, you can access this information using the following linking reaction format: <cite>_ID_time03_time04</cite>, where <cite>_ID</cite>
denotes the identifier of the original metabolite. This format encapsulates the amount of metabolite transitioning from time-step 3 to time-step 4.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Get the amount of metabolite S on time 1</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fluxes</span><span class="p">[</span><span class="s2">&quot;S_e_time00_time01&quot;</span><span class="p">])</span> <span class="c1">#97.8</span>

<span class="c1">#Get the concentration of metabolite B in time step 22</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fluxes</span><span class="p">[</span><span class="s2">&quot;B_e_time21_time22&quot;</span><span class="p">])</span> <span class="c1">#6.311</span>

<span class="c1">#Get the amount of A at the end of the simulation</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fluxes</span><span class="p">[</span><span class="s1">&#39;A_e_exchange_final&#39;</span><span class="p">])</span> <span class="c1">#0.0</span>
</pre></div>
</div>
<p>Given that this approach may not be the most intuitive method for retrieving information from the object, <code class="docutils literal notranslate"><span class="pre">EndPointFBA</span></code>
follows a similar pattern to other methods by enhancing the core functionality of the <code class="docutils literal notranslate"><span class="pre">DynamicModelBase</span></code> class.
This inheritance grants it the capability to easily access biomasses, metabolites, and fluxes at each time point.
By leveraging these properties, you can obtain the data in a more straightforward manner, with the values neatly organized per time-step.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">biomasses</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">get_biomasses</span><span class="p">()</span>
<span class="n">metabolites</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">get_metabolites</span><span class="p">()</span>
<span class="n">fluxes</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">get_fluxes</span><span class="p">()</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">get_time_points</span><span class="p">()</span>
</pre></div>
</div>
<p>Now you can retrieve the metabolite concentration of metabolite <cite>S</cite> and the aggregated flux value of reaction <cite>R_1_modelA</cite> using the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Concentration of metabolite S on time point 1</span>
<span class="n">metabolites</span><span class="p">[</span><span class="s2">&quot;S_e&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">#aggregated flux through reaction R_1_modelA</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">get_flux_values</span><span class="p">(</span><span class="s2">&quot;R_1_modelA&quot;</span><span class="p">)</span>

<span class="c1">#print the value of the flux at time point 5</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="c1">#1.2763</span>
</pre></div>
</div>
<p><cite>EndPointFBA</cite> uses aggregated fluxes (that is the flux multiplied by <cite>dt</cite> and <cite>biomass</cite>), to obtain the original, or specific flux value you can call the following method:</p>
<p>Putting it all together we can again plot the biomasses, metabolites and fluxes over time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">metabolites</span><span class="p">[</span><span class="s2">&quot;S_e&quot;</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Metabolite s&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">metabolites</span><span class="p">[</span><span class="s2">&quot;A_e&quot;</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Metabolite a&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">metabolites</span><span class="p">[</span><span class="s2">&quot;B_e&quot;</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Metabolite B&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration&quot;</span><span class="p">)</span>
<span class="c1"># Adding legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biomasses</span><span class="p">[</span><span class="s2">&quot;modelA&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;modelA&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biomasses</span><span class="p">[</span><span class="s2">&quot;modelB&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;modelB&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)),</span>
    <span class="n">ep</span><span class="o">.</span><span class="n">get_specific_flux_values</span><span class="p">(</span><span class="s2">&quot;R_1_modelA&quot;</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;R_1_modelA&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)),</span>
    <span class="n">ep</span><span class="o">.</span><span class="n">get_specific_flux_values</span><span class="p">(</span><span class="s2">&quot;R_1_modelB&quot;</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;R_1_modelA&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/metabolites_epFBA.png"><img alt="Metabolite concentrations" class="align-center" src="../_images/metabolites_epFBA.png" style="width: 500px;" /></a>
<a class="reference internal image-reference" href="../_images/biomasses_epFBA.png"><img alt="Metabolite concentrations" class="align-center" src="../_images/biomasses_epFBA.png" style="width: 500px;" /></a>
<a class="reference internal image-reference" href="../_images/Flux_r_1_epFBA.png"><img alt="Metabolite concentrations" class="align-center" src="../_images/Flux_r_1_epFBA.png" style="width: 500px;" /></a>
</section>
<section id="advanced-constraints">
<h2>7.3 Advanced constraints<a class="headerlink" href="#advanced-constraints" title="Permalink to this heading"></a></h2>
<p>EndPointFBA offers additional methods for refining your simulation results, enhancing the biological relevance. Here, we discuss these methods and demonstrate their application.</p>
<section id="enforcing-balanced-growth">
<h3>7.3.1 Enforcing balanced growth<a class="headerlink" href="#enforcing-balanced-growth" title="Permalink to this heading"></a></h3>
<p>A significant advantage of using <cite>EndPointFBA</cite> lies in the fact that all variables are accessible and can be constrained prior to running the simulation.
Leveraging this capability, we can impose constraints on the model in a way that allows us to fix species abundances or the relative ratios of species within the
community at both the initial and final time points. By implementing these constraints, we compel the community model to maintain stability, preventing any single organism from persistently outgrowing others.
Unchecked differential growth rates over time can lead to the dominance of one member within the community, which is often unrealistic in many biological scenarios.
Therefore, within epFBA, we offer users the option to apply constraints that ensure biomass ratios at the initial and final time points remain equal,
ensuring a time-averaged community ratio.</p>
<p>To do this you need to know two parameters, the initial total biomass of the system and the desired or final value of the community biomass.</p>
</section>
<section id="optimal-time-search">
<h3>7.3.2 Optimal time search<a class="headerlink" href="#optimal-time-search" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">OptimalSearch.time_search</span></code> module helps determine the optimal number of intervals required to reach the maximum objective method value. By default, the chosen number of intervals might either stretch resources too thinly or not utilize them fully, leading to skewed FBA results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dcFBA.OptimalSearch</span> <span class="kn">import</span> <span class="n">time_search</span>

<span class="n">optimal_timepoints</span> <span class="o">=</span> <span class="n">time_search</span><span class="p">(</span>
    <span class="n">community_model</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;modelA&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;modelB&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;S_e&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;A_e&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;B_e&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
    <span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">optimal_timepoints</span><span class="p">)</span>  <span class="c1"># 21</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Keep in mind, this search might be time-consuming as it involves iterative model construction and simulation.</p>
</div>
<p>Otherwise, you can use the <code class="docutils literal notranslate"><span class="pre">OptimalSearch.time_search</span></code> method to find the number of time points required to reach a certain biomass value.
For example, we know that we can reach the maximal value of the model in 21 time steps. But what if we want an accumulated biomass of 6.5, how long will this take?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">optimal_timepoints</span> <span class="o">=</span> <span class="n">time_search</span><span class="p">(</span>
    <span class="n">community_model</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;modelA&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;modelB&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;S_e&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;A_e&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;B_e&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
        <span class="mf">0.1</span><span class="p">,</span>
        <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span> <span class="mi">21</span><span class="p">],</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">optimal_timepoints</span><span class="p">)</span> <span class="c1">#[13, 7.04]</span>
</pre></div>
</div>
<p>In this context, we’ve set the initial estimate for ‘N’ to 21, based on our knowledge that within 21 time steps, we can achieve a value greater than 6.5.
The method returns a list where the first index represents the number of time steps, and the final index indicates the resulting objective value obtained after those time steps.</p>
</section>
<section id="restricting-reaction-bounds">
<h3>7.3.3 Restricting reaction bounds<a class="headerlink" href="#restricting-reaction-bounds" title="Permalink to this heading"></a></h3>
<p>In the context of steady-state microbial community dynamics, drastic changes in reaction rates between two successive time points are unlikely.
To capture this behavior more accurately, we have implemented two methods to minimize these fluctuations.</p>
<p>The first approach introduces a constraint on the model to ensure that the reaction rate at time <code class="docutils literal notranslate"><span class="pre">N</span></code> doesn’t vary more than a predefined value,
<span class="math notranslate nohighlight">\(\epsilon\)</span>, from its rate at time <code class="docutils literal notranslate"><span class="pre">N-1</span></code>.
This method effectively smoothens the fluctuations
in reaction rates, leading to more biologically plausible results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Activate the additional constraints with epsilon set to 0.1</span>
<span class="n">ep</span><span class="o">.</span><span class="n">constrain_rates</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">solution</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">simulate</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span> <span class="c1"># 12.599</span>

<span class="n">FBAsol</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">m_model</span><span class="o">.</span><span class="n">getSolutionVector</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">FBAsol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">FBAsol</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">FBAsol</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

 <span class="c1"># Print the rates for a particular reaction at successive time points</span>
<span class="nb">print</span><span class="p">(</span><span class="n">FBAsol</span><span class="p">[</span><span class="s2">&quot;R_1_modelA_time01&quot;</span><span class="p">])</span> <span class="c1">#1.062</span>
<span class="nb">print</span><span class="p">(</span><span class="n">FBAsol</span><span class="p">[</span><span class="s2">&quot;R_1_modelA_time02&quot;</span><span class="p">])</span> <span class="c1">#1.128</span>
<span class="nb">print</span><span class="p">(</span><span class="n">FBAsol</span><span class="p">[</span><span class="s2">&quot;R_1_modelA_time03&quot;</span><span class="p">])</span> <span class="c1">#1.975</span>
</pre></div>
</div>
<p>As demonstrated, the variation in reaction rates between consecutive time points remains within the <span class="math notranslate nohighlight">\(\epsilon\)</span> boundary of 0.1.</p>
<p>A more sophisticated approach to minimizing fluctuations in reaction rates involves quadratic programming.
The idea is to set the <cite>EndPointFBA</cite> model’s objective to minimize the sum of squared differences between reaction rates at successive time points. Here’s how you can employ this approach:</p>
<ol class="arabic simple">
<li><p>First, simulate the <cite>EndPointFBA</cite> model to obtain the optimal solution value, or desired value.</p></li>
<li><p>Use the obtained optimal solution value as a constraint for the <cite>EndPointFBA</cite> model.</p></li>
<li><p>Set the new objective function to minimize the sum of squared differences between reaction rates at two consecutive time points.</p></li>
</ol>
<p>The resulting objective function is expressed as:</p>
<div class="math notranslate nohighlight">
\[\min \sum_{j, n} (r_{j,n} - r_{j,n+1})^2\]</div>
<p>Where r<sub>j,n</sub>denotes the rate of reaction <code class="docutils literal notranslate"><span class="pre">j</span></code> at time point <code class="docutils literal notranslate"><span class="pre">n</span></code>.</p>
<p>The following code demonstrates how to implement this approach:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the objective value of community biomass to 12.77</span>
<span class="n">ep</span><span class="o">.</span><span class="n">set_qp</span><span class="p">(</span><span class="mf">12.77</span><span class="p">)</span>

<span class="c1"># Simulate the model with the new quadratic objective</span>
<span class="n">ep</span><span class="o">.</span><span class="n">simulate</span><span class="p">()</span>

 <span class="n">time</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">get_time_points</span><span class="p">()</span>

 <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
     <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)),</span>
     <span class="n">ep</span><span class="o">.</span><span class="n">get_specific_flux_values</span><span class="p">(</span><span class="s2">&quot;R_1_modelA&quot;</span><span class="p">),</span>
     <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
     <span class="n">label</span><span class="o">=</span><span class="s2">&quot;R_1_modelA&quot;</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
     <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)),</span>
     <span class="n">ep</span><span class="o">.</span><span class="n">get_specific_flux_values</span><span class="p">(</span><span class="s2">&quot;R_1_modelB&quot;</span><span class="p">),</span>
     <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
     <span class="n">label</span><span class="o">=</span><span class="s2">&quot;R_1_modelA&quot;</span><span class="p">,</span>
 <span class="p">)</span>
 <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
 <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux&quot;</span><span class="p">)</span>
 <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
 <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Plotting the same fluxes as we did above we see that we have a much smoother transition of flux value between time points:</p>
<a class="reference internal image-reference" href="../_images/EP_fluxes_with_qp.png"><img alt="Metabolite concentrations" class="align-center" src="../_images/EP_fluxes_with_qp.png" style="width: 500px;" /></a>
<p>Happy modelling!</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="ref-epfba" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>ep paper</p>
</aside>
</aside>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../6_parallel_dfba/home.html" class="btn btn-neutral float-left" title="6. Dynamic Parallel FBA" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../8_Advanced/home.html" class="btn btn-neutral float-right" title="8. Advanced Topics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, S.C.M.A. Wijnen, F. Moro.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>